# -----------------------------------------------------------------------------
# |           ðŸ¤– THE ULTIMATE ALL-IN-ONE AUTONOMOUS CI SYSTEM ðŸ¤–           |
# |                  Designed for 100% Production Readiness                 |
# -----------------------------------------------------------------------------

name: 'ðŸš€ Ultimate Autonomous CI'

# =============================================================================
# | ðŸ§  1. TRIGGERS (THE SENSES) - à¸ªà¹ˆà¸§à¸™à¸£à¸±à¸šà¸£à¸¹à¹‰à¹à¸¥à¸°à¸ªà¸±à¹ˆà¸‡à¸à¸²à¸£à¸—à¸³à¸‡à¸²à¸™                    |
# =============================================================================
on:
  # à¸—à¸£à¸´à¸à¹€à¸à¸­à¸£à¹Œà¹€à¸Šà¸´à¸‡à¸£à¸¸à¸ (Proactive): à¸•à¸£à¸§à¸ˆà¸ªà¸­à¸šà¹à¸¥à¸°à¸šà¸³à¸£à¸¸à¸‡à¸£à¸±à¸à¸©à¸²à¸£à¸°à¸šà¸šà¸—à¸¸à¸à¸§à¸±à¸™à¸•à¸­à¸™à¸•à¸µ 2 UTC
  schedule:
    - cron: '0 2 * * *'

  # à¸—à¸£à¸´à¸à¹€à¸à¸­à¸£à¹Œà¹€à¸Šà¸´à¸‡à¸£à¸±à¸š (Reactive): à¸—à¸³à¸‡à¸²à¸™à¸—à¸±à¸™à¸—à¸µà¹€à¸¡à¸·à¹ˆà¸­à¸¡à¸µà¹‚à¸„à¹‰à¸”à¹ƒà¸«à¸¡à¹ˆà¹€à¸‚à¹‰à¸²à¸¡à¸²
  push:
    branches:
      - 'main'
      - 'develop'
  
  # à¸—à¸£à¸´à¸à¹€à¸à¸­à¸£à¹Œà¸•à¸£à¸§à¸ˆà¸ªà¸­à¸šà¸„à¸¸à¸“à¸ à¸²à¸ž: à¸—à¸³à¸‡à¸²à¸™à¹€à¸¡à¸·à¹ˆà¸­à¸¡à¸µà¸à¸²à¸£à¹€à¸›à¸´à¸” Pull Request
  pull_request:
    branches:
      - 'main'
      - 'develop'

  # à¸—à¸£à¸´à¸à¹€à¸à¸­à¸£à¹Œà¸”à¹‰à¸§à¸¢à¸¡à¸·à¸­: à¸­à¸™à¸¸à¸à¸²à¸•à¹ƒà¸«à¹‰à¸ªà¸±à¹ˆà¸‡à¸£à¸±à¸™à¸£à¸°à¸šà¸šà¹„à¸”à¹‰à¹€à¸­à¸‡ Ø¹Ù†Ø¯à¸„à¸§à¸²à¸¡à¸•à¹‰à¸­à¸‡à¸à¸²à¸£
  workflow_dispatch:

# =============================================================================
# | âš™ï¸ PERMISSIONS - à¸à¸²à¸£à¸à¸³à¸«à¸™à¸”à¸ªà¸´à¸—à¸˜à¸´à¹Œà¸à¸²à¸£à¹€à¸‚à¹‰à¸²à¸–à¸¶à¸‡                             |
# =============================================================================
# à¸•à¸±à¹‰à¸‡à¸„à¹ˆà¸²à¸ªà¸´à¸—à¸˜à¸´à¹Œà¹ƒà¸«à¹‰ Workflow à¸ªà¸²à¸¡à¸²à¸£à¸–à¸ªà¸£à¹‰à¸²à¸‡ PR à¹à¸¥à¸° Issue à¹„à¸”à¹‰ à¸‹à¸¶à¹ˆà¸‡à¸ˆà¸³à¹€à¸›à¹‡à¸™à¸ªà¸³à¸«à¸£à¸±à¸šà¸£à¸°à¸šà¸š Self-Healing
permissions:
  contents: write
  pull-requests: write
  issues: write

# =============================================================================
# |                            JOBS - à¸à¸£à¸°à¸šà¸§à¸™à¸à¸²à¸£à¸—à¸³à¸‡à¸²à¸™                          |
# =============================================================================
jobs:
  # ---------------------------------------------------------------------------
  # | JOB 1: AUTONOMOUS MAINTENANCE & VALIDATION                              |
  # ---------------------------------------------------------------------------
  autonomous_system:
    name: 'ðŸ›¡ï¸ Autonomous Maintain & Validate'
    runs-on: ubuntu-latest

    steps:
      # --- Setup Phase ---
      - name: '1.1. System Checkout'
        uses: actions/checkout@v4
        with:
          # à¸”à¸¶à¸‡à¸‚à¹‰à¸­à¸¡à¸¹à¸¥ commit à¸—à¸±à¹‰à¸‡à¸«à¸¡à¸”à¹€à¸žà¸·à¹ˆà¸­à¹ƒà¸«à¹‰à¸ªà¸²à¸¡à¸²à¸£à¸–à¹€à¸›à¸£à¸µà¸¢à¸šà¹€à¸—à¸µà¸¢à¸šà¸à¸²à¸£à¹€à¸›à¸¥à¸µà¹ˆà¸¢à¸™à¹à¸›à¸¥à¸‡à¹„à¸”à¹‰
          fetch-depth: 0 

      - name: '1.2. Environment Setup (Node.js + Cache)'
        uses: actions/setup-node@v4
        with:
          node-version: '20.x'
          # à¹€à¸›à¸´à¸”à¹ƒà¸Šà¹‰à¸‡à¸²à¸™ Cache à¸ªà¸³à¸«à¸£à¸±à¸š npm à¹‚à¸”à¸¢à¸­à¸±à¸•à¹‚à¸™à¸¡à¸±à¸•à¸´à¸•à¸²à¸¡ Best Practice
          cache: 'npm'

      - name: '1.3. Dependency Synchronization'
        run: npm ci

      # --- Self-Healing Phase ---
      - name: '2.1. Heal: Auto-Patch Vulnerabilities & Format Code'
        id: auto_heal_step
        run: |
          echo "Changes detected before healing: $(git status --porcelain=v1 2>/dev/null | wc -l)"
          
          # à¸‹à¹ˆà¸­à¸¡à¹à¸‹à¸¡à¸Šà¹ˆà¸­à¸‡à¹‚à¸«à¸§à¹ˆà¸„à¸§à¸²à¸¡à¸›à¸¥à¸­à¸”à¸ à¸±à¸¢à¸£à¸°à¸”à¸±à¸šà¸•à¹ˆà¸³à¸–à¸¶à¸‡à¸à¸¥à¸²à¸‡à¹‚à¸”à¸¢à¸­à¸±à¸•à¹‚à¸™à¸¡à¸±à¸•à¸´
          npm audit fix --audit-level=moderate
          
          # à¸ˆà¸±à¸”à¸£à¸°à¹€à¸šà¸µà¸¢à¸šà¹‚à¸„à¹‰à¸”à¸—à¸±à¹‰à¸‡à¸«à¸¡à¸”à¹ƒà¸«à¹‰à¹€à¸›à¹‡à¸™à¸¡à¸²à¸•à¸£à¸à¸²à¸™à¹€à¸”à¸µà¸¢à¸§à¸à¸±à¸™
          npx prettier --write .
          
          echo "Changes detected after healing: $(git status --porcelain=v1 2>/dev/null | wc -l)"
          
          # à¸•à¸£à¸§à¸ˆà¸ªà¸­à¸šà¸§à¹ˆà¸²à¸¡à¸µà¸à¸²à¸£à¹€à¸›à¸¥à¸µà¹ˆà¸¢à¸™à¹à¸›à¸¥à¸‡à¹„à¸Ÿà¸¥à¹Œà¸«à¸£à¸·à¸­à¹„à¸¡à¹ˆ à¹à¸¥à¸°à¸ªà¹ˆà¸‡à¸œà¸¥à¸¥à¸±à¸žà¸˜à¹Œà¸­à¸­à¸à¹„à¸›
          if [[ -n $(git status --porcelain) ]]; then
            echo "changes_detected=true" >> $GITHUB_OUTPUT
          else
            echo "changes_detected=false" >> $GITHUB_OUTPUT
          fi
          
      - name: '2.2. Remediate: Create Pull Request with Applied Fixes'
        if: steps.auto_heal_step.outputs.changes_detected == 'true'
        uses: peter-evans/create-pull-request@v6
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          commit-message: 'fix(auto): Apply automated security patches and formatting'
          title: 'ðŸ¤– CI [Auto-Heal]: Security & Style Fixes'
          body: |
            This Pull Request was automatically generated by the **Ultimate Autonomous CI** workflow.
            
            It contains the following automated fixes to maintain project health and security:
            - **Security Patches**: Applied via `npm audit fix`.
            - **Code Formatting**: Standardized using `prettier`.
            
            This is a routine maintenance action. Please review and merge.
          branch: 'ci/auto-fixes'
          delete-branch: true
          labels: 'automated-pr, maintenance'
          assignees: '${{ github.actor }}'

      # --- Validation Phase ---
      - name: '3.1. Validate: Build Project'
        run: npm run build --if-present

      - name: '3.2. Validate: Run All Tests'
        run: npm test

      # --- Failure Response Phase ---
      - name: '4.1. Report: Auto-Create Issue on Critical Failure'
        if: failure() && github.event_name != 'pull_request'
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          gh issue create \
            --title "ðŸš¨ CRITICAL FAILURE in CI on branch '${{ github.ref_name }}' [${{ github.sha }}]" \
            --body "The **Ultimate Autonomous CI** workflow failed and could not self-heal.
            - **Triggered by:** ${{ github.event_name }} by @${{ github.actor }}
            - **Branch:** `${{ github.ref_name }}`
            - **Commit:** `${{ github.sha }}`
            - **Workflow Log:** [Click here to view logs](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})
            
            ### **Manual intervention is urgently required.**" \
            --label "bug,critical,ci-failure" \
            --assignee "${{ github.actor }}"
